<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPBAA Member Payments</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Stripe JS SDK -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f9ff;
        }
        .input-field:focus {
            ring: 3px solid #0ea5e9;
            outline: none;
            border-color: #0ea5e9;
        }
        /* Radio Card Styling */
        .radio-card:checked + div {
            background-color: #e0f2fe;
            border-color: #0284c7;
            color: #0c4a6e;
        }
        .radio-card:checked + div .check-icon {
            opacity: 1;
        }
        
        /* Method Tabs */
        .method-tab.active {
            background-color: #0369a1; /* Sky 700 */
            color: white;
            border-color: #0369a1;
        }
        .method-tab:not(.active) {
            background-color: white;
            color: #4b5563; /* Gray 600 */
            border-color: #d1d5db; /* Gray 300 */
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0284c7;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Stripe Element Container */
        #payment-element {
            min-height: 250px; /* Prevent layout jump */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-sky-700 text-white shadow-lg">
        <div class="max-w-3xl mx-auto px-4 py-6 flex flex-col items-center text-center">
            <i class="fa-solid fa-water text-4xl mb-2"></i>
            <h1 class="text-2xl md:text-3xl font-bold">Schicke Point Beach Access Association</h1>
            <p class="text-sky-100 mt-1 text-lg">Secure Member Payment Portal</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex items-start justify-center p-4 md:p-8">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-xl overflow-hidden border border-gray-100">
            
            <div class="bg-sky-50 p-6 border-b border-sky-100">
                <h2 class="text-xl font-semibold text-sky-900 mb-2">Welcome, Neighbor</h2>
                <p class="text-gray-700 leading-relaxed text-lg">
                    Please use the form below to pay your association dues.
                </p>
            </div>

            <form id="payment-form" class="p-6 space-y-6">
                
                <!-- Payment Type Selection -->
                <div>
                    <label class="block text-gray-800 font-bold text-lg mb-3">What are you paying for?</label>
                    <div class="grid grid-cols-1 gap-3">
                        <!-- Option 1: Standard Dues -->
                        <div>
                            <label class="cursor-pointer relative block">
                                <input type="radio" name="paymentType" value="standard" class="radio-card sr-only" checked onchange="togglePaymentType()">
                                <div class="border-2 border-gray-200 rounded-lg p-4 pr-12 flex items-center justify-between hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center">
                                        <i class="fa-solid fa-calendar-check text-sky-600 text-xl mr-3"></i>
                                        <div>
                                            <div class="font-bold text-lg">Yearly Dues</div>
                                            <div class="text-gray-500">Standard Rate</div>
                                        </div>
                                    </div>
                                    <div class="font-bold text-xl text-sky-700">$100.00</div>
                                    <i class="check-icon fa-solid fa-circle-check text-sky-600 text-2xl absolute right-4 opacity-0 transition-opacity"></i>
                                </div>
                            </label>
                            
                            <!-- Auto Pay Option -->
                            <div id="auto-pay-container" class="mt-2 ml-1 p-2 bg-sky-50 rounded border border-sky-100 transition-all">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="autoPay" class="h-5 w-5 text-sky-600 rounded focus:ring-sky-500 border-gray-300">
                                    <span class="text-gray-800 font-medium">Auto-Pay: Charge me every August 1st</span>
                                </label>
                            </div>
                        </div>

                        <!-- Option 2: Special Assessment -->
                        <label class="cursor-pointer relative block">
                            <input type="radio" name="paymentType" value="assessment" class="radio-card sr-only" onchange="togglePaymentType()">
                            <div class="border-2 border-gray-200 rounded-lg p-4 pr-12 flex items-center justify-between hover:bg-gray-50 transition-colors">
                                <div class="flex items-center">
                                    <i class="fa-solid fa-clipboard-list text-orange-500 text-xl mr-3"></i>
                                    <div>
                                        <div class="font-bold text-lg">Special Assessment</div>
                                        <div class="text-gray-500">Infrastructure & Repairs</div>
                                    </div>
                                </div>
                                <i class="check-icon fa-solid fa-circle-check text-sky-600 text-2xl absolute right-4 opacity-0 transition-opacity"></i>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Member Details -->
                <div class="space-y-4">
                    <div>
                        <label for="memberName" class="block text-gray-700 font-semibold mb-1 text-lg">Full Name</label>
                        <input type="text" id="memberName" class="input-field w-full p-3 border border-gray-300 rounded-lg text-lg" placeholder="e.g. John Smith">
                    </div>

                    <div>
                        <label for="address" class="block text-gray-700 font-semibold mb-1 text-lg">Schicke Point Address or Lot #</label>
                        <input type="text" id="address" class="input-field w-full p-3 border border-gray-300 rounded-lg text-lg" placeholder="e.g. 123 Beach Drive">
                    </div>

                    <div>
                        <label for="memberNumber" class="block text-gray-700 font-semibold mb-1 text-lg">Member Number</label>
                        <input type="text" id="memberNumber" class="input-field w-full p-3 border border-gray-300 rounded-lg text-lg" placeholder="e.g. 1042">
                    </div>

                    <div id="customAmountContainer" class="hidden bg-orange-50 p-4 rounded-lg border border-orange-100">
                        <label for="customAmount" class="block text-gray-800 font-bold mb-1 text-lg">Assessment Amount ($)</label>
                        <input type="number" id="customAmount" class="input-field w-full p-3 border border-gray-300 rounded-lg text-xl font-bold text-gray-800" placeholder="0.00">
                    </div>
                </div>

                <!-- Stripe Payment Interface -->
                <div class="mt-6 border-t pt-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Select Payment Method</h3>
                    
                    <!-- Method Toggle Buttons -->
                    <div class="flex space-x-2 mb-4">
                        <button type="button" onclick="setMethod('card')" id="tab-card" class="method-tab active flex-1 py-3 px-4 rounded-lg border font-semibold flex items-center justify-center transition-all">
                            <i class="fa-regular fa-credit-card mr-2"></i> Card
                        </button>
                        <button type="button" onclick="setMethod('ach')" id="tab-ach" class="method-tab flex-1 py-3 px-4 rounded-lg border font-semibold flex items-center justify-center transition-all">
                            <i class="fa-solid fa-building-columns mr-2"></i> Bank (ACH)
                        </button>
                    </div>

                    <!-- Payment Element View -->
                    <div id="view-payment" class="space-y-3">
                        <div id="card-message" class="p-3 bg-gray-50 border border-gray-200 rounded text-sm text-gray-600 mb-2">
                            <i class="fa-solid fa-shield-halved text-green-600 mr-1"></i> Secure credit or debit card transaction.
                        </div>
                        <div id="ach-message" class="hidden p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800 mb-2">
                            <i class="fa-solid fa-info-circle mr-1"></i> You will link your bank account securely via Stripe.
                        </div>
                        
                        <!-- Stripe Payment Element Container (Handles both Card and ACH) -->
                        <div id="payment-element"></div>
                        <div id="error-message" class="text-red-600 text-sm mt-1"></div>
                    </div>
                </div>

                <!-- Fee Breakdown & Total -->
                <div class="bg-gray-100 p-4 rounded-lg border border-gray-200 mt-6">
                    <div class="flex justify-between text-gray-600 mb-1">
                        <span>Dues/Assessment:</span>
                        <span id="display-subtotal">$100.00</span>
                    </div>
                    <div class="flex justify-between text-gray-600 mb-1 text-sm">
                        <span>Processing Fee (<span id="fee-label">Card</span>):</span>
                        <span id="display-fee">$0.00</span>
                    </div>
                    <div class="border-t border-gray-300 my-2"></div>
                    <div class="flex justify-between font-bold text-lg text-gray-800">
                        <span>Total Charge:</span>
                        <span id="display-total">$100.00</span>
                    </div>
                </div>

                <!-- Error/Success Messages -->
                <div id="payment-status-container" class="hidden p-4 rounded-lg text-center mt-4"></div>

                <!-- Pay Button -->
                <button type="button" id="pay-button" onclick="handlePayment()" class="mt-4 w-full bg-sky-700 hover:bg-sky-800 text-white font-bold text-xl py-4 px-6 rounded-lg shadow-md transition-transform transform active:scale-95 flex justify-center items-center">
                    <span id="btn-text">Pay Now</span>
                    <span id="btn-amount" class="ml-2">($103.30)</span>
                    <div id="btn-loader" class="loader ml-3 hidden"></div>
                </button>
            </form>
        </div>
    </main>

    <footer class="bg-gray-800 text-gray-300 py-6 text-center mt-auto">
        <p class="mb-2">&copy; 2024 Schicke Point Beach Access Association</p>
        <p class="text-sm">Need help? Call the treasurer.</p>
    </footer>

    <script>
        // --- CONFIGURATION ---
        // REPLACE WITH YOUR ACTUAL PUBLISHABLE KEY
        const stripePublicKey = 'pk_test_51SnmiNAbuoVPVZze06SHPR3KQ9dNsBvp0XUBre6IRwI1L7BMMBIwherC23cRoPukSuY9EIRguO5amy90JjHpcBwV00TGenrBat'; 
        const BACKEND_URL = ''; // Relative path

        // --- FEE CONFIGURATION ---
        const FEE_CARD_PERCENT = 0.029;
        const FEE_CARD_FIXED = 0.30;
        // ACH: 0.8%, capped at $5.00
        const FEE_ACH_PERCENT = 0.008;
        const FEE_ACH_CAP = 5.00;

        // --- STATE ---
        let subtotalAmount = 100.00;
        let totalAmount = 0;
        let currentMethod = 'card';
        let stripe;
        let elements;
        let paymentElement;
        let debounceTimer;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            calculateTotals();
            stripe = Stripe(stripePublicKey);
            
            // Initial Payment Element Creation (Client-Side Only)
            renderPaymentElement();
        });

        // --- CALCULATIONS ---
        function calculateTotals() {
            let fee = 0;
            if(isNaN(subtotalAmount) || subtotalAmount < 0) subtotalAmount = 0;

            if (currentMethod === 'card') {
                if (subtotalAmount > 0) {
                    let requiredTotal = (subtotalAmount + FEE_CARD_FIXED) / (1 - FEE_CARD_PERCENT);
                    fee = requiredTotal - subtotalAmount;
                }
                document.getElementById('fee-label').textContent = "Card";
            } else {
                // ACH Logic
                let calculatedFee = subtotalAmount * FEE_ACH_PERCENT;
                if (calculatedFee > FEE_ACH_CAP) calculatedFee = FEE_ACH_CAP;
                fee = calculatedFee;
                document.getElementById('fee-label').textContent = "Bank (ACH)";
            }

            totalAmount = subtotalAmount + fee;

            document.getElementById('display-subtotal').textContent = `$${subtotalAmount.toFixed(2)}`;
            document.getElementById('display-fee').textContent = `$${fee.toFixed(2)}`;
            document.getElementById('display-total').textContent = `$${totalAmount.toFixed(2)}`;
            document.getElementById('btn-amount').textContent = `($${totalAmount.toFixed(2)})`;
        }

        // --- STRIPE UI MANAGEMENT (Client-Side Init) ---
        function renderPaymentElement() {
            if (subtotalAmount <= 0) return; 

            // If elements already exists, unmount first
            if (paymentElement) {
                paymentElement.unmount();
            }

            const appearance = { theme: 'stripe' };
            
            // Initialize Elements WITHOUT a clientSecret initially (Deferred Intent Flow)
            // This prevents "fetch" errors on load
            elements = stripe.elements({ 
                appearance,
                mode: 'payment',
                currency: 'usd',
                amount: Math.round(totalAmount * 100),
                paymentMethodTypes: [currentMethod === 'ach' ? 'us_bank_account' : 'card'],
            });
            
            paymentElement = elements.create("payment", {
                layout: "tabs",
                // Hiding terms if needed, or let Stripe handle it
            });
            
            paymentElement.mount("#payment-element");
        }

        // --- UI LOGIC ---
        function togglePaymentType() {
            const radios = document.getElementsByName('paymentType');
            let selectedType;
            for (const radio of radios) if (radio.checked) selectedType = radio.value;

            const customContainer = document.getElementById('customAmountContainer');
            const autoPayContainer = document.getElementById('auto-pay-container');
            const customInput = document.getElementById('customAmount');

            if (selectedType === 'standard') {
                customContainer.classList.add('hidden');
                autoPayContainer.classList.remove('hidden');
                subtotalAmount = 100.00;
                renderPaymentElement();
            } else {
                customContainer.classList.remove('hidden');
                autoPayContainer.classList.add('hidden');
                document.getElementById('autoPay').checked = false;
                customInput.value = ""; 
                subtotalAmount = 0;
            }
            calculateTotals();
        }

        function setMethod(method) {
            if (currentMethod === method) return;
            currentMethod = method;
            
            // Toggle Tab Styling
            if (method === 'card') {
                document.getElementById('tab-card').classList.add('active');
                document.getElementById('tab-ach').classList.remove('active');
                document.getElementById('card-message').classList.remove('hidden');
                document.getElementById('ach-message').classList.add('hidden');
            } else {
                document.getElementById('tab-ach').classList.add('active');
                document.getElementById('tab-card').classList.remove('active');
                document.getElementById('ach-message').classList.remove('hidden');
                document.getElementById('card-message').classList.add('hidden');
            }

            calculateTotals();
            // Re-render to enforce method type restriction (Card vs Bank)
            renderPaymentElement(); 
        }

        // Debounce custom amount input
        document.getElementById('customAmount').addEventListener('input', function(e) {
            const val = parseFloat(e.target.value);
            subtotalAmount = isNaN(val) ? 0 : val;
            calculateTotals();
            
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (subtotalAmount > 0) {
                    // Update the existing elements amount
                    elements.update({ amount: Math.round(totalAmount * 100) });
                }
            }, 800); 
        });

        // --- SUBMIT PAYMENT ---
        async function handlePayment() {
            const statusContainer = document.getElementById('payment-status-container');
            const btn = document.getElementById('pay-button');
            const loader = document.getElementById('btn-loader');
            const name = document.getElementById('memberName').value;
            const address = document.getElementById('address').value;
            const memberNum = document.getElementById('memberNumber').value;
            const isAutoPay = document.getElementById('autoPay').checked;

            statusContainer.classList.add('hidden');

            if (!name || !address || !memberNum) {
                showStatus("Please enter your name, address, and member number.", "error");
                return;
            }
            if (!stripe || !elements) {
                showStatus("Payment system not ready. Please refresh.", "error");
                return;
            }

            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            loader.classList.remove('hidden');

            try {
                // 1. Submit the form elements first (Validation)
                const { error: submitError } = await elements.submit();
                if (submitError) {
                    throw new Error(submitError.message);
                }

                // 2. Fetch the PaymentIntent from your backend
                // This is where we create the "secret" key
                const response = await fetch(`${BACKEND_URL}/create-payment-intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: Math.round(totalAmount * 100),
                        paymentMethodType: currentMethod,
                        isAutoPay: isAutoPay,
                        name: name,
                        memberNum: memberNum
                    })
                });

                if (!response.ok) {
                    throw new Error("Could not connect to payment server. If you are seeing this locally, ensure server.js is running.");
                }

                const { clientSecret } = await response.json();

                // 3. Confirm the Payment
                const { error } = await stripe.confirmPayment({
                    elements,
                    clientSecret, // Pass the secret we just got
                    confirmParams: {
                        return_url: window.location.href, 
                        payment_method_data: {
                            billing_details: {
                                name: name,
                                address: { line1: address }
                            }
                        }
                    },
                    redirect: 'if_required'
                });

                if (error) {
                    showStatus(error.message, "error");
                } else {
                    let successMsg = "Success! Payment processed.";
                    if (currentMethod === 'ach') successMsg = "Success! Bank transfer initiated. Check your email.";
                    if (isAutoPay) successMsg += " Auto-pay enabled.";
                    
                    showStatus(successMsg, "success");
                    document.getElementById('payment-form').reset();
                    // Optional: reload to clear state
                    setTimeout(() => window.location.reload(), 3000);
                }

            } catch (e) {
                console.error(e);
                showStatus(e.message, "error");
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                loader.classList.add('hidden');
            }
        }

        function showStatus(message, type) {
            const el = document.getElementById('payment-status-container');
            el.textContent = message;
            el.classList.remove('hidden');
            el.className = 'p-4 rounded-lg text-center mt-4';
            if (type === 'error') {
                el.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
            } else {
                el.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
            }
        }
    </script>
</body>
</html>